{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import type { Node, Slice } from '@milkdown/prose/model'\n\nimport {\n  editorViewOptionsCtx,\n  parserCtx,\n  schemaCtx,\n  serializerCtx,\n} from '@milkdown/core'\nimport { getNodeFromSchema } from '@milkdown/prose'\nimport { DOMParser, DOMSerializer } from '@milkdown/prose/model'\nimport { Plugin, PluginKey, TextSelection } from '@milkdown/prose/state'\nimport { $prose } from '@milkdown/utils'\n\ntype UnknownRecord = Record<string, unknown>\nfunction isPureText(\n  content: UnknownRecord | UnknownRecord[] | undefined | null\n): boolean {\n  if (!content) return false\n  if (Array.isArray(content)) {\n    if (content.length > 1) return false\n    return isPureText(content[0])\n  }\n\n  const child = content.content\n  if (child) return isPureText(child as UnknownRecord[])\n\n  return content.type === 'text'\n}\n\nfunction isTextOnlySlice(slice: Slice): Node | false {\n  if (slice.content.childCount === 1) {\n    const node = slice.content.firstChild\n    if (node?.type.name === 'text' && node.marks.length === 0) return node\n\n    if (node?.type.name === 'paragraph' && node.childCount === 1) {\n      const _node = node.firstChild\n      if (_node?.type.name === 'text' && _node.marks.length === 0) return _node\n    }\n  }\n\n  return false\n}\n\n/// The prosemirror plugin for clipboard.\nexport const clipboard = $prose((ctx) => {\n  const schema = ctx.get(schemaCtx)\n\n  // Set editable props for https://github.com/Milkdown/milkdown/issues/190\n  ctx.update(editorViewOptionsCtx, (prev) => ({\n    ...prev,\n    editable: prev.editable ?? (() => true),\n  }))\n\n  const key = new PluginKey('MILKDOWN_CLIPBOARD')\n  const plugin = new Plugin({\n    key,\n    props: {\n      handlePaste: (view, event) => {\n        const parser = ctx.get(parserCtx)\n        const editable = view.props.editable?.(view.state)\n        const { clipboardData } = event\n        if (!editable || !clipboardData) return false\n\n        const currentNode = view.state.selection.$from.node()\n        if (currentNode.type.spec.code) return false\n\n        const text = clipboardData.getData('text/plain')\n\n        // if is copied from vscode, try to create a code block\n        const vscodeData = clipboardData.getData('vscode-editor-data')\n        if (vscodeData) {\n          const data = JSON.parse(vscodeData)\n          const language = data?.mode\n          if (text && language) {\n            const { tr } = view.state\n            const codeBlock = getNodeFromSchema('code_block', schema)\n\n            tr.replaceSelectionWith(codeBlock.create({ language }))\n              .setSelection(\n                TextSelection.near(\n                  tr.doc.resolve(Math.max(0, tr.selection.from - 2))\n                )\n              )\n              .insertText(text.replace(/\\r\\n?/g, '\\n'))\n\n            view.dispatch(tr)\n            return true\n          }\n        }\n\n        const html = clipboardData.getData('text/html')\n        if (html.length === 0 && text.length === 0) return false\n\n        const domParser = DOMParser.fromSchema(schema)\n        let dom\n        if (html.length === 0) {\n          const slice = parser(text)\n          if (!slice || typeof slice === 'string') return false\n\n          dom = DOMSerializer.fromSchema(schema).serializeFragment(\n            slice.content\n          )\n        } else {\n          const template = document.createElement('template')\n          template.innerHTML = html\n          dom = template.content.cloneNode(true)\n          template.remove()\n        }\n\n        const slice = domParser.parseSlice(dom)\n        const node = isTextOnlySlice(slice)\n        if (node) {\n          view.dispatch(view.state.tr.replaceSelectionWith(node, true))\n          return true\n        }\n\n        view.dispatch(view.state.tr.replaceSelection(slice))\n        return true\n      },\n      clipboardTextSerializer: (slice) => {\n        const serializer = ctx.get(serializerCtx)\n        const isText = isPureText(slice.content.toJSON())\n        if (isText)\n          return (slice.content as unknown as Node).textBetween(\n            0,\n            slice.content.size,\n            '\\n\\n'\n          )\n\n        const doc = schema.topNodeType.createAndFill(undefined, slice.content)\n        if (!doc) return ''\n        const value = serializer(doc)\n        return value\n      },\n    },\n  })\n\n  return plugin\n})\n\nclipboard.meta = {\n  displayName: 'Prose<clipboard>',\n  package: '@milkdown/plugin-clipboard',\n}\n"],"names":["slice"],"mappings":"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"}