{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import type { MilkdownPlugin } from '@milkdown/ctx'\nimport type { Node } from '@milkdown/prose/model'\nimport type { EditorState } from '@milkdown/prose/state'\n\nimport { Plugin, PluginKey } from '@milkdown/prose/state'\nimport { $ctx, $prose } from '@milkdown/utils'\n\n/// Options for trailing config.\nexport interface TrailingConfigOptions {\n  /// A function that returns a boolean value.\n  /// If it returns `true`, the plugin will append a node at the end of the document.\n  /// By default, it returns `false` if the last node is a heading or a paragraph.\n  shouldAppend: (lastNode: Node | null, state: EditorState) => boolean\n  /// A function that returns a node.\n  /// By default, it returns a paragraph node.\n  getNode: (state: EditorState) => Node\n}\n\n/// A slice contains the trailing config.\n/// You can use [TrailingConfigOptions](#TrailingConfigOptions) to customize the behavior of the plugin.\nexport const trailingConfig = $ctx<TrailingConfigOptions, 'trailingConfig'>(\n  {\n    shouldAppend: (lastNode) => {\n      if (!lastNode) return false\n\n      if (['heading', 'paragraph'].includes(lastNode.type.name)) return false\n\n      return true\n    },\n    getNode: (state) => state.schema.nodes.paragraph!.create(),\n  },\n  'trailingConfig'\n)\n\ntrailingConfig.meta = {\n  package: '@milkdown/plugin-trailing',\n  displayName: 'Ctx<trailingConfig>',\n}\n\n/// The prosemirror plugin for trailing.\nexport const trailingPlugin = $prose((ctx) => {\n  const trailingPluginKey = new PluginKey('MILKDOWN_TRAILING')\n  const { shouldAppend, getNode } = ctx.get(trailingConfig.key)\n  const plugin = new Plugin({\n    key: trailingPluginKey,\n    state: {\n      init: (_, state) => {\n        const lastNode = state.tr.doc.lastChild\n\n        return shouldAppend(lastNode, state)\n      },\n      apply: (tr, value, _, state) => {\n        if (!tr.docChanged) return value\n\n        const lastNode = tr.doc.lastChild\n\n        return shouldAppend(lastNode, state)\n      },\n    },\n    appendTransaction: (_, __, state) => {\n      const { doc, tr } = state\n      const nodeType = getNode?.(state)\n      const shouldInsertNodeAtEnd = plugin.getState(state)\n      const endPosition = doc.content.size\n\n      if (!shouldInsertNodeAtEnd || !nodeType) return\n\n      return tr.insert(endPosition, nodeType)\n    },\n  })\n\n  return plugin\n})\n\ntrailingPlugin.meta = {\n  package: '@milkdown/plugin-trailing',\n  displayName: 'Prose<trailing>',\n}\n\n/// All plugins exported by this package.\nexport const trailing: MilkdownPlugin[] = [trailingConfig, trailingPlugin]\n"],"names":[],"mappings":";;AAoBO,MAAM,iBAAiB;AAAA,EAC5B;AAAA,IACE,cAAc,CAAC,aAAa;AACtB,UAAA,CAAC,SAAiB,QAAA;AAElB,UAAA,CAAC,WAAW,WAAW,EAAE,SAAS,SAAS,KAAK,IAAI,EAAU,QAAA;AAE3D,aAAA;AAAA,IACT;AAAA,IACA,SAAS,CAAC,UAAU,MAAM,OAAO,MAAM,UAAW,OAAO;AAAA,EAC3D;AAAA,EACA;AACF;AAEA,eAAe,OAAO;AAAA,EACpB,SAAS;AAAA,EACT,aAAa;AACf;AAGa,MAAA,iBAAiB,OAAO,CAAC,QAAQ;AACtC,QAAA,oBAAoB,IAAI,UAAU,mBAAmB;AAC3D,QAAM,EAAE,cAAc,YAAY,IAAI,IAAI,eAAe,GAAG;AACtD,QAAA,SAAS,IAAI,OAAO;AAAA,IACxB,KAAK;AAAA,IACL,OAAO;AAAA,MACL,MAAM,CAAC,GAAG,UAAU;AACZ,cAAA,WAAW,MAAM,GAAG,IAAI;AAEvB,eAAA,aAAa,UAAU,KAAK;AAAA,MACrC;AAAA,MACA,OAAO,CAAC,IAAI,OAAO,GAAG,UAAU;AAC1B,YAAA,CAAC,GAAG,WAAmB,QAAA;AAErB,cAAA,WAAW,GAAG,IAAI;AAEjB,eAAA,aAAa,UAAU,KAAK;AAAA,MAAA;AAAA,IAEvC;AAAA,IACA,mBAAmB,CAAC,GAAG,IAAI,UAAU;AAC7B,YAAA,EAAE,KAAK,GAAA,IAAO;AACd,YAAA,WAAW,mCAAU;AACrB,YAAA,wBAAwB,OAAO,SAAS,KAAK;AAC7C,YAAA,cAAc,IAAI,QAAQ;AAE5B,UAAA,CAAC,yBAAyB,CAAC,SAAU;AAElC,aAAA,GAAG,OAAO,aAAa,QAAQ;AAAA,IAAA;AAAA,EACxC,CACD;AAEM,SAAA;AACT,CAAC;AAED,eAAe,OAAO;AAAA,EACpB,SAAS;AAAA,EACT,aAAa;AACf;AAGa,MAAA,WAA6B,CAAC,gBAAgB,cAAc;"}